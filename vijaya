#! /bin/bash

# ==========================
# Help Function
# ==========================
help_function()
{
    echo "$0 provides information about files and folders including size, statistics, duplicate detection, and cleanup suggestion"
    echo
    echo "Usage:"
    echo "$0 [-l location] [-e extension] [-s stats] [-d duplicate] [-c cleanup] [-h help]"
    echo
    echo "Options:"
    echo "-l : Specify location"
    echo "-e : Specify file extension"
    echo "-s : Show statistics"
    echo "-d : Detect duplicate files"
    echo "-c : Show cleanup suggestions"
    echo "-h : Show help"
    echo
    echo "Examples:"
    echo "$0"
    echo "$0 -l /etc"
    echo "$0 -l /etc -e conf -s"
    echo "$0 -l /home -d"
    echo "$0 -l /home -c"
    echo "$0 -l /home -s -d -c"
    exit 2
}

# ==========================
# Default Variables
# ==========================
LOCATION=$(pwd)
EXTENSION=""
STATS=0
DUPLICATE=0
CLEANUP=0

# ==========================
# Argument Processing
# ==========================
while [ $# -ne 0 ]
do
    case $1 in

        -l | --location)
            LOCATION=$2
            if [ ! -d "$LOCATION" ]; then
                echo "Invalid directory"
                exit 1
            fi
            shift 2
            ;;

        -e | --extension)
            EXTENSION=$2
            shift 2
            ;;

        -s | --stats)
            STATS=1
            shift
            ;;

        -d | --duplicate)
            DUPLICATE=1
            shift
            ;;

        -c | --cleanup)
            CLEANUP=1
            shift
            ;;

        -h | --help)
            help_function
            ;;

        *)
            echo "Invalid option"
            help_function
            ;;
    esac
done

# ==========================
# Analysis Section
# ==========================

echo "Analyzing location: $LOCATION"
echo

# Count folders
FOLDER_COUNT=$(find "$LOCATION" -maxdepth 1 -type d | wc -l)
FOLDER_COUNT=$((FOLDER_COUNT - 1))

# Get file list
if [ "$EXTENSION" = "" ]; then
    FILE_LIST=$(find "$LOCATION" -maxdepth 1 -type f)
else
    FILE_LIST=$(find "$LOCATION" -maxdepth 1 -type f -name "*.$EXTENSION")
fi

FILE_COUNT=$(echo "$FILE_LIST" | grep -c .)

# Calculate total size
TOTAL_SIZE=0

for file in $FILE_LIST
do
    size=$(stat -c%s "$file")
    TOTAL_SIZE=$((TOTAL_SIZE + size))
done

KB=$(echo "scale=2; $TOTAL_SIZE/1024" | bc)
MB=$(echo "scale=2; $TOTAL_SIZE/1024/1024" | bc)

# Display results
echo "Number of folders: $FOLDER_COUNT"
echo "Number of files: $FILE_COUNT"
echo "Total file size: $TOTAL_SIZE Bytes"
echo "Total file size: $KB KB"
echo "Total file size: $MB MB"

echo

# ==========================
# Statistics Section
# ==========================

if [ $STATS -eq 1 ] && [ "$FILE_COUNT" -gt 0 ]; then

    SMALLEST_FILE=""
    LARGEST_FILE=""
    MIN_SIZE=999999999
    MAX_SIZE=0

    for file in $FILE_LIST
    do
        size=$(stat -c%s "$file")

        if [ $size -lt $MIN_SIZE ]; then
            MIN_SIZE=$size
            SMALLEST_FILE=$(basename "$file")
        fi

        if [ $size -gt $MAX_SIZE ]; then
            MAX_SIZE=$size
            LARGEST_FILE=$(basename "$file")
        fi
    done

    echo "Statistics:"
    echo "Smallest file: $SMALLEST_FILE ($MIN_SIZE Bytes)"
    echo "Largest file: $LARGEST_FILE ($MAX_SIZE Bytes)"

    echo
fi

# ==========================
# Duplicate File Detection
# ==========================

if [ $DUPLICATE -eq 1 ]; then

    echo "Duplicate File Detection:"
    DUPLICATES=$(find "$LOCATION" -type f -exec md5sum {} + | sort | uniq -w32 -d)

    if [ -z "$DUPLICATES" ]; then
        echo "No duplicate files found"
    else
        find "$LOCATION" -type f -exec md5sum {} + | sort | uniq -w32 --all-repeated=separate
    fi

    echo
fi

# ==========================
# Smart Cleanup Suggestion
# ==========================

if [ $CLEANUP -eq 1 ]; then

    echo "Smart Cleanup Suggestion:"
    echo "Files not accessed in last 30 days:"

    OLD_FILES=$(find "$LOCATION" -type f -atime +30)

    if [ -z "$OLD_FILES" ]; then
        echo "No unused files found"
    else
        echo "$OLD_FILES"
    fi

    echo
fi
